---
title: 'Quality control : File formats'
author: Francoise
date: '`r format(Sys.Date(), "%B %d, %Y")`'
---

# 檔案格式

資料以「PLINK」格式給出，這是目前基於晶片的GWAS資料中最常見的格式。`PLINK`是一個開源的全基因組聯合分析工具集，旨在以計算效率高的方式執行一系列基本的大規模分析。作為工具集的一部分，PLINK具有其自己的檔案格式--這些已成為GWAS領域的標準格式。以PLINK格式存儲的資料以「包」的形式呈現--即，一個PLINK資料集由一組檔案組成，而不僅僅是一個資料檔。了解如何使用PLINK命令行工具分析這些檔案中的資料是很有價值的，但是對於沒有命令行經驗的人來說，這可能是一個艱巨的開始。幸運的是，我們也可以通過`R`與`PLINK`進行交互。我們將使用的套件是[bigsnpr](https://privefl.github.io/bigsnpr/)。

讓我們來看看PLINK檔案結構，查看每個檔案中存儲了哪些信息。

在壓縮檔中包含了三個執行GWAS所需的檔案，即`.bed`、`.bim`和`.fam`檔。我將這些檔案保存到一個名為`data/`的資料夾中。

## `.fam`

這個檔案包含了有關受試者的信息：

```{r fam}
head(fam <- fread('data/penncath.fam'))
```

這裡有1401行，每行對應一個受試者。六列分別是：

1. 家庭ID
2. 個體ID
3. 父親ID
4. 母親ID
5. 性別（1=男性；2=女性；其他=未知）
6. 表型

在這個資料集中，第2到第4列不重要。通常情況下，它們用於指定家譜（例如，受試者3是受試者1和2的女兒）。但是，在這項研究中，沒有受試者有關聯，所以唯一重要的列是第一列，記錄了受試者的唯一ID。

表型通常用於記錄病例對照狀態或類似的信息，但也很常見將臨床/生物信息單獨記錄在一個表格中，這就是這裡所做的。

```{r clinical}
(clinical <- fread('data/penncath.csv'))
```

您可以看到，我們有`FamID`來將此表格與基因資料匹配起來，疾病狀態（`CAD=1`表示受試者患有冠狀動脈疾病），以及一些共變量（年齡、三酸甘油脂、HDL和LDL膽固醇水平）。

## `.bim`

相比之下，`.bim`檔包含了關於基因座（SNP）的信息：

```{r bim}
bim <- fread('data/penncath.bim')
head(bim)
```

您可以看到，這裡有`r nrow(bim)`行，每行對應研究中測量的一個SNP。列如下：

1. 染色體（1-22、X、Y或0表示未定位）
2. rs#或snp識別符
3. 遺傳距離（morgans）
4. 基對位置（bp單位）
5. 等位基因1（通常是小等位基因，或“效應”等位基因）
6. 等位基因2（通常是大等位基因）

通常會忽略第三列，就像這裡一樣。許多常見的分析不需要基對位置。

因此，例如，檔告訴我們，基因座rs12565286位於染色體1的721290個碱基位置處，大多數人在這裡有一個C，但有些人有一個G。當然，“大多數人”是相對於一個群體來說的--請確認與合作者確切了解哪個等位基因被認為是“小等位基因”，以及資料中描述了哪些群體。更多關於“群體結構”的概念將在後面的模組中介紹。

## `.bed`

最後，`.bed`檔，它包含所有資料。這是三個檔案中最大的一個，因為它包含了每個受試者和每個基因座的`r nrow(fam)`乘以`r nrow(bim)`的基因型呼叫矩陣。為了使事情變得可管理，這個檔案以一種特殊的二

進位格式編碼--即，您不能只是在文本編輯器中打開檔案或使用`fread()`之類的方式加載它。也就是說，我們可以將我們的PLINK資料轉換為`bigSNP`對象（在`bigsnpr`中定義）--這將使我們能夠在`R`會話中查看我們的資料。

```{r}
# install.packages("bigsnpr") # 如果您是第一次使用此套件，請運行此命令
library(bigsnpr)
library(bigstatsr) # bigsnpr的一個有用依賴庫
```

要將此檔案讀取到`R`中，僅需運行以下程式碼塊**一次**。這將在您保存了`penncath.bed`的同一目錄中創建您需要的.rds和.bk檔。

```{r read-plink, eval=FALSE}
# 注意：該函數假定所有檔案的基本檔案名相同，只是它們的擴展名不同。

snp_readBed("data/penncath.bed")
```

現在，將資料讀入到您的R會話中
```{r}
penncath <- snp_attach("data/penncath.rds")

# 查看這個bigSNP對象
str(penncath)
```

從這裡開始，`bigsnpr`有很多函數可以幫助我們準備分析資料--這些函數依賴於您在本地計算機上安裝了[PLINK 1.9](https://www.cog-genomics.org/plink2)。轉到該頁面，下載檔案，並將其保存到您的計算機上（我將此類檔案保存在`~/bin/`中）。為了確定PLINK是否安裝正確並且已準備就緒，請在命令行提示符或RStudio的“終端”中輸入`path/to/plink --version`，其中填寫路徑為您保存下載檔案的路徑。如果一切正常，您將看到一條消息，類似於`PLINK v1.90b6.26 64-bit (2 Apr 2022)`--其中的`PLINK v1.9`是關鍵。

注意：在PLINK檔中，缺失值通常記錄為“-9”--`bigsnpr`套件也遵循這一慣例。這就是您將在`bigSNP`對象的“map”元素中看到的情況--缺失的等位基因代碼，會插入“-9”。
